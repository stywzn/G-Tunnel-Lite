import socket
import threading
import time
import random

# é…ç½®ï¼šç›®æ ‡æ˜¯ä½ æœ¬åœ°çš„ Go ç¨‹åºç›‘å¬ç«¯å£
TARGET_IP = '127.0.0.1'
TARGET_PORT = 8080

# é…ç½®ï¼šå¹¶å‘çº¿ç¨‹æ•° (æ¨¡æ‹Ÿå¤šå°‘ä¸ªç”¨æˆ·åŒæ—¶è¿æ¥)
CONCURRENCY = 100 
# é…ç½®ï¼šæ¯ä¸ªç”¨æˆ·å‘å¤šå°‘æ¬¡åŒ…
REQUESTS_PER_THREAD = 5

def attack(thread_id):
    """æ¯ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ·ï¼Œå»ºç«‹è¿æ¥å¹¶å‘é€æ•°æ®"""
    try:
        # 1. å»ºç«‹è¿æ¥ (Connect)
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(5) # 5ç§’è¶…æ—¶
        s.connect((TARGET_IP, TARGET_PORT))
        
        print(f"[Thread-{thread_id}] âœ… Connected!")

        # 2. å‘é€ä¸€äº› HTTP åƒåœ¾æ•°æ® (Send)
        # æˆ‘ä»¬ä¸ç®¡ç™¾åº¦å›ä»€ä¹ˆï¼Œåªè¦å‘å‡ºå»å°±ç®—æˆåŠŸ
        payload = f"GET / HTTP/1.1\r\nHost: localhost\r\nUser-Agent: StressTest\r\n\r\n"
        
        for i in range(REQUESTS_PER_THREAD):
            s.sendall(payload.encode())
            # æ¥æ”¶ä¸€ç‚¹æ•°æ®ï¼Œè¯æ˜é€šè·¯æ˜¯æ´»çš„
            data = s.recv(1024)
            if not data:
                break
            # éšæœºä¼‘çœ ä¸€ä¸‹ï¼Œæ¨¡æ‹ŸçœŸå®äººç±»è¡Œä¸º
            time.sleep(random.uniform(0.1, 0.5))
            
        s.close()
        print(f"[Thread-{thread_id}] ğŸ‘‹ Closed normally")
        
    except Exception as e:
        print(f"[Thread-{thread_id}] âŒ Error: {e}")

def start_stress_test():
    threads = []
    print(f"ğŸš€ Starting Stress Test: {CONCURRENCY} threads connecting to {TARGET_IP}:{TARGET_PORT}")
    
    start_time = time.time()

    # å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
    for i in range(CONCURRENCY):
        t = threading.Thread(target=attack, args=(i,))
        threads.append(t)
        t.start()
        # ç¨å¾®é”™å¼€ä¸€ç‚¹å¯åŠ¨æ—¶é—´ï¼Œé¿å…ç¬é—´æŠŠ OS ç«¯å£è€—å°½
        time.sleep(0.01)

    # ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
    for t in threads:
        t.join()

    end_time = time.time()
    print(f"\nğŸ Test Finished in {end_time - start_time:.2f} seconds!")

if __name__ == "__main__":
    start_stress_test()